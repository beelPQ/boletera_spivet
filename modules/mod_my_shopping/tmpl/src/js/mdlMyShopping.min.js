(()=>{"use strict";let e="/modules/mod_my_shopping/tmpl",t=null,l=null,a=null,i=async(e,t,l)=>{let a=[];a="GET"==t?{method:"GET"}:{method:"POST",body:l};let i=await fetch(e,a);return await i.json()},n=()=>{let e=[].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));e.map(function(e){return a=new bootstrap.Tooltip(e)})},d=e=>{let t=e.getAttribute("data-id"),a=e.getAttribute("data-uri"),i=e.getAttribute("data-name")||"";l.querySelector("#staticMdlFilePaymentLabel").innerHTML=i.trim();let n=l.querySelector(".modal-dialog"),d=l.querySelector(".modal-body");d.innerHTML="";let r=document.createElement("div");r.classList.add("content_file"),r.id=t;let s=a.split(".")[1],o=["png","jpg","jpeg","webp","PNG","JPG","JPEG","WEBP"],c=o.filter(e=>e==s);if(n.classList.remove("modal-lg"),c.length>0){let p=document.createElement("img");p.src=a,p.classList.add("file"),r.appendChild(p)}else{n.classList.add("modal-lg");let u=null;"PDF"==s.toUpperCase()?(u=document.createElement("embed")).type="application/pdf":u=document.createElement("iframe"),u.src=a,u.setAttribute("width","100%"),u.setAttribute("height","600px"),r.appendChild(u)}d.appendChild(r)},r=(e,t,l,a,i)=>{l.classList.remove("success"),l.innerHTML='<i class="fas fa-file-upload"></i>',a.removeChild(e),a.removeChild(t),i.setAttribute("data-bs-toggle","tooltip"),i.setAttribute("title","Adjuntar comprobante"),i.setAttribute("data-bs-delay","100")},s=(t,a)=>{let i=null;if(a.files.length>0){i=a.files[0];let s=a.id,o=t.closest("td");t.removeAttribute("title"),t.removeAttribute("aria-label"),t.removeAttribute("data-bs-original-title");let c=t.querySelector(".icon_file");c.classList.add("success"),c.innerHTML=`<i class="fas fa-check-circle"></i> ${i.name}`;let p=document.createElement("span"),u=document.createElement("button"),m=document.createElement("div");m.classList.add("contentProgress"),o.querySelector(".cancel_file")||(p.classList.add("cancel_file"),p.innerHTML='<i class="fas fa-times-circle"></i>',p.addEventListener("click",()=>{r(p,u,c,o,t)}),o.appendChild(p)),o.querySelector(".uploadFile")||(u.classList.add("uploadFile"),u.innerHTML='<i class="fas fa-file-import"></i>',u.addEventListener("click",()=>{let a=new FormData;a.append("method","uploadVoucher"),a.append("fileVoucher",i),a.append("idFile",s);let n=document.createElement("progress");n.id="progressBar",n.value="0",n.max="100";let r=document.createElement("p");r.id="status",m.appendChild(n),m.appendChild(r),o.appendChild(m),t.style.display="none",p.style.display="none",u.style.display="none";let c=new XMLHttpRequest;c.open("POST",`${e}/controllers/myShopping.php`,!0),c.upload.onprogress=function(e){let t=e.loaded/e.total*100;n.value=t,r.textContent=`Subiendo: ${t.toFixed(2)}%`},c.onload=function(){if(200===c.status){let e="",a="",i="";if(c.responseText.includes("status")){let n=JSON.parse(c.responseText),{status:s,message:b,description:y,data:f}=n;if(!s){r.textContent="Error al subir el archivo.",setTimeout(()=>{t.removeAttribute("style"),p.removeAttribute("style"),u.removeAttribute("style"),o.removeChild(m)},2500);return}r.textContent=b,f.hasOwnProperty("id")&&(e=f.id),f.hasOwnProperty("filename")&&(a=f.filename),f.hasOwnProperty("type")&&(i=f.type)}setTimeout(()=>{o.innerHTML="";let t=l.querySelector(".modal-dialog");"docto"==i?t.classList.add("modal-lg"):t.classList.remove("modal-lg");let n=document.createElement("button");n.type="button",n.id="viewFilePay",n.setAttribute("data-id",e),n.setAttribute("data-uri",`/files/adjuntos/${a}`),n.setAttribute("data-name",a),n.setAttribute("data-bs-toggle","modal"),n.setAttribute("data-bs-target","#staticMdlFilePayment"),n.innerHTML='<i class="fas fa-eye"></i>',n.addEventListener("click",()=>d(n)),n.classList.add("iconFileView","download"),o.appendChild(n);let r=document.createElement("a");r.href=`/files/adjuntos/${a}`,r.classList.add("iconFileDownUp","download"),r.setAttribute("download",a),r.setAttribute("data-id",e),r.setAttribute("data-bs-toggle","tooltip"),r.setAttribute("title","Descargar comprobante"),r.setAttribute("data-bs-delay","100"),r.innerHTML='<i class="fas fa-file-download"></i>',o.appendChild(r)},2e3)}else r.textContent="Error al subir el archivo.",setTimeout(()=>{t.removeAttribute("style"),p.removeAttribute("style"),u.removeAttribute("style"),o.removeChild(m)},2500)},c.onerror=function(){r.textContent="Error al subir el archivo.",setTimeout(()=>{t.removeAttribute("style"),p.removeAttribute("style"),u.removeAttribute("style"),o.removeChild(m)},2500)},c.send(a)}),o.appendChild(u)),setTimeout(()=>{n()},300)}},o=()=>{let l=localStorage.getItem("userid")??"",a=new FormData;a.append("method","my_shopping"),a.append("id",l),i(`${e}/controllers/myShopping.php`,"POST",a).then(e=>{console.clear();let{status:l,message:a,description:i,data:n}=e,r=t.querySelector("tbody");l&&n.length>0&&(console.clear(),r.innerHTML="",n.forEach(({id:e,idPay:t,idtransaccion:l,idtransaccion_secondary:a,moneda:i,montotransaccion:n,comision_total:o,fechapago:c,status:p,pdf:u,adjunto:m,notes:b,paymentItems:y},f)=>{let g=document.createElement("tr"),h=document.createElement("td");h.innerHTML=`<div>${f+=1}</div>`;let v=document.createElement("td");v.innerHTML=`<div>${t}</div>`;let $=document.createElement("td"),L=new Date(c),A=L.getDate(),E=10>parseInt(A)?`0${A}`:A,w=L.getMonth()+1,C=10>parseInt(w)?`0${w}`:w,T=L.getFullYear(),P=L.getHours(),M=P%12||12,S=10>parseInt(M)?`0${M}`:M,F=L.getMinutes(),_=10>parseInt(F)?`0${F}`:F,H=L.getSeconds(),q=10>parseInt(H)?`0${H}`:H,x=`${E}/${C}/${T}  ${S}:${_}:${q}`;$.innerHTML=`<div>${x}</div>`;let j=document.createElement("td");j.innerHTML=1==p?`<div class="success" >✅ Pagado</div>`:`<div class="panding" >⚠️ Pendiente</div>`;let D=document.createElement("td");D.innerHTML=null!==m&&""!=m.trim()?`<div class="contentBtnsVU" ><button type="button" id="viewFilePay"  data-id="${e}" data-uri="/files/adjuntos/${m}" data-name="${m}" data-bs-toggle="modal" data-bs-target="#staticMdlFilePayment" class="iconFileView download"><i class="fas fa-eye"></i></button><a href="/files/adjuntos/${m}" download class="iconFileDownUp download" data-id="${e}" data-bs-toggle="tooltip" title="Descargar comprobante" data-bs-delay="100" ><i class="fas fa-file-download"></i><a></div>`:`<button type="button" id="uploadFilePay" class="iconFileDownUp upload" data-id="${e}-${t}" data-bs-toggle="tooltip" title="Adjuntar comprobante" data-bs-delay="100" ><input id="${e}-${t}" type="file" accept=".pdf, .png, .jpg, .jpeg" hidden ><span class="icon_file" ><i class="fas fa-file-upload"></i></span></button>`,g.appendChild(h),g.appendChild(v),g.appendChild($),g.appendChild(j),g.appendChild(D),r.appendChild(g),setTimeout(()=>{let e=r.querySelectorAll("#uploadFilePay");e.forEach(e=>{let t=e.getAttribute("data-id")||"",l=e.querySelector(`input#${t}`);l.addEventListener("change",t=>{t.preventDefault(),s(e,l)}),e.addEventListener("click",()=>l.click())});let t=r.querySelectorAll("#viewFilePay");t.forEach(e=>{e.addEventListener("click",()=>d(e))})},500)}))}).catch(e=>{console.log(e),Swal.fire({title:"Error inesperado",text:"Tuvimos problemas al obtener las compras",icon:"error",confirmButtonText:"Aceptar",confirmButtonColor:"#000",allowOutsideClick:!1,allowEscapeKey:!1})})};document.addEventListener("DOMContentLoaded",()=>{t=document.querySelector("#tblPaymentsUser")||null,l=document.querySelector("#staticMdlFilePayment")||null,null!==t&&o()}),window.addEventListener("load",()=>{n()})})();